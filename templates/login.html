{% extends "base.html" %}

{% block title %}Login - CS2 Server Manager{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-6 col-lg-4">
        <div class="card shadow-sm">
            <div class="card-body">
                <h2 class="card-title text-center mb-4">
                    <i class="bi bi-box-arrow-in-right"></i> <span data-i18n="login.title">Login</span>
                </h2>
                
                <div id="error-message" class="alert alert-danger d-none" role="alert"></div>
                
                <form id="login-form">
                    <div class="mb-3">
                        <label for="username" class="form-label" data-i18n="login.username">Username</label>
                        <input type="text" class="form-control" id="username" name="username" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="password" class="form-label" data-i18n="login.password">Password</label>
                        <input type="password" class="form-control" id="password" name="password" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="captcha" class="form-label" data-i18n="login.captcha">Verification Code</label>
                        <div class="d-flex gap-2 align-items-center">
                            <img id="captcha-image" src="" alt="CAPTCHA" class="border" style="height: 80px; cursor: pointer;" title="Click to refresh">
                            <input type="text" class="form-control" id="captcha" name="captcha" maxlength="4" required placeholder="Enter code" style="max-width: 120px;">
                            <button type="button" class="btn btn-outline-secondary" id="refresh-captcha" title="Refresh CAPTCHA">
                                <i class="bi bi-arrow-clockwise"></i>
                            </button>
                        </div>
                        <input type="hidden" id="captcha-token" name="captcha-token">
                    </div>
                    
                    <button type="submit" class="btn btn-primary w-100" id="submit-btn">
                        <i class="bi bi-box-arrow-in-right"></i> <span data-i18n="login.loginButton">Login</span>
                    </button>
                    
                    <div class="text-center mt-3">
                        <a href="/forgot-password" class="text-decoration-none" data-i18n="nav.forgotPassword">Forgot Password</a>
                    </div>
                </form>
                
                <div class="d-grid gap-2 my-3">
                    <button type="button" class="btn btn-outline-dark" id="google-login-btn">
                        <svg width="18" height="18" viewBox="0 0 48 48" style="vertical-align: middle; margin-right: 8px;">
                            <path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/>
                            <path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/>
                            <path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/>
                            <path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/>
                            <path fill="none" d="M0 0h48v48H0z"/>
                        </svg>
                        <span data-i18n="login.continueWithGoogle">Continue with Google</span>
                    </button>
                </div>
                
                <hr class="my-4">
                
                <div class="text-center">
                    <p class="mb-0"><span data-i18n="login.noAccount">Don't have an account?</span> <a href="/register" data-i18n="login.registerHere">Register here</a></p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Load CAPTCHA on page load
async function loadCaptcha() {
    try {
        const response = await fetch('/api/captcha/image/new');
        const token = response.headers.get('X-Captcha-Token');
        const blob = await response.blob();
        const imageUrl = URL.createObjectURL(blob);
        
        document.getElementById('captcha-image').src = imageUrl;
        document.getElementById('captcha-token').value = token;
    } catch (error) {
        console.error('Failed to load CAPTCHA:', error);
    }
}

// Refresh CAPTCHA
document.getElementById('refresh-captcha').addEventListener('click', loadCaptcha);
document.getElementById('captcha-image').addEventListener('click', loadCaptcha);

// Load CAPTCHA when page loads
loadCaptcha();

document.getElementById('login-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const submitBtn = document.getElementById('submit-btn');
    const errorDiv = document.getElementById('error-message');
    
    submitBtn.disabled = true;
    const loggingInText = window.i18n ? window.i18n.t('login.loggingIn') : 'Logging in...';
    submitBtn.innerHTML = `<i class="bi bi-hourglass-split"></i> ${loggingInText}`;
    errorDiv.classList.add('d-none');
    
    try {
        const response = await fetch('/api/auth/login', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                username: document.getElementById('username').value,
                password: document.getElementById('password').value,
                captcha_token: document.getElementById('captcha-token').value,
                captcha_code: document.getElementById('captcha').value
            })
        });
        
        const data = await response.json();
        
        if (!response.ok) {
            throw new Error(data.detail || (window.i18n ? window.i18n.t('login.loginFailed') : 'Login failed'));
        }
        
        // Store token in localStorage
        localStorage.setItem('access_token', data.access_token);
        
        // Redirect to servers page
        window.location.href = '/servers-ui';
        
    } catch (error) {
        errorDiv.textContent = error.message;
        errorDiv.classList.remove('d-none');
        submitBtn.disabled = false;
        const loginText = window.i18n ? window.i18n.t('login.loginButton') : 'Login';
        submitBtn.innerHTML = `<i class="bi bi-box-arrow-in-right"></i> ${loginText}`;
        // Refresh CAPTCHA on error
        loadCaptcha();
    }
});

// Google Sign-In
let googleClientId = null;

async function loadGoogleSignIn() {
    try {
        // Fetch Google OAuth config from backend
        const configResponse = await fetch('/api/auth/google-config');
        
        if (!configResponse.ok) {
            throw new Error('Failed to fetch Google OAuth configuration');
        }
        
        const config = await configResponse.json();
        
        if (!config.enabled || !config.client_id) {
            // Hide Google login button if not configured
            const googleBtn = document.getElementById('google-login-btn');
            if (googleBtn) {
                googleBtn.style.display = 'none';
            }
            return;
        }
        
        googleClientId = config.client_id;
        
        // Load Google Sign-In library
        const script = document.createElement('script');
        script.src = 'https://accounts.google.com/gsi/client';
        script.async = true;
        script.defer = true;
        script.onerror = () => {
            console.error('Failed to load Google Sign-In library');
            const googleBtn = document.getElementById('google-login-btn');
            if (googleBtn) {
                googleBtn.style.display = 'none';
            }
        };
        document.head.appendChild(script);
    } catch (error) {
        console.error('Failed to load Google OAuth config:', error);
        const googleBtn = document.getElementById('google-login-btn');
        if (googleBtn) {
            googleBtn.style.display = 'none';
        }
    }
}

// Handle Google Sign-In
document.getElementById('google-login-btn').addEventListener('click', async () => {
    if (!googleClientId) {
        const errorDiv = document.getElementById('error-message');
        errorDiv.textContent = 'Google OAuth is not configured';
        errorDiv.classList.remove('d-none');
        return;
    }
    
    try {
        // Use popup-based OAuth flow instead of One Tap to avoid FedCM issues
        const authUrl = `https://accounts.google.com/o/oauth2/v2/auth?` +
            `client_id=${encodeURIComponent(googleClientId)}&` +
            `redirect_uri=${encodeURIComponent(window.location.origin + '/google-callback')}&` +
            `response_type=id_token&` +
            `scope=openid%20email%20profile&` +
            `nonce=${Date.now()}`;
        
        // Open popup window for OAuth
        const width = 500;
        const height = 600;
        const left = (screen.width - width) / 2;
        const top = (screen.height - height) / 2;
        
        const popup = window.open(
            authUrl,
            'Google Sign-In',
            `width=${width},height=${height},left=${left},top=${top},resizable=yes,scrollbars=yes`
        );
        
        // Listen for message from popup
        window.addEventListener('message', async function handleOAuthMessage(event) {
            // Check origin for security
            if (event.origin !== window.location.origin) return;
            
            if (event.data.type === 'google-oauth-token') {
                window.removeEventListener('message', handleOAuthMessage);
                
                if (popup && !popup.closed) {
                    popup.close();
                }
                
                await handleGoogleCredentialResponse({ credential: event.data.id_token });
            }
        });
        
    } catch (error) {
        console.error('Google Sign-In error:', error);
        const errorDiv = document.getElementById('error-message');
        errorDiv.textContent = 'Failed to open Google Sign-In. Please try again.';
        errorDiv.classList.remove('d-none');
    }
});

async function handleGoogleCredentialResponse(response) {
    const errorDiv = document.getElementById('error-message');
    
    try {
        // Send ID token to backend
        const backendResponse = await fetch('/api/auth/google-oauth', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                id_token: response.credential
            })
        });
        
        const data = await backendResponse.json();
        
        if (backendResponse.status === 400 && data.detail && data.detail.includes('Username and password required')) {
            // New user, need to register
            showGoogleRegistrationModal(response.credential, data.detail);
        } else if (!backendResponse.ok) {
            throw new Error(data.detail || 'Google login failed');
        } else {
            // Login successful
            localStorage.setItem('access_token', data.access_token);
            window.location.href = '/servers-ui';
        }
    } catch (error) {
        errorDiv.textContent = error.message;
        errorDiv.classList.remove('d-none');
    }
}

function showGoogleRegistrationModal(idToken, message) {
    // Create a modal for new user registration
    const modalHtml = `
        <div class="modal fade" id="googleRegisterModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Complete Registration</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <p class="text-muted mb-3">Welcome! Please choose a username and password to complete your registration.</p>
                        <div id="modal-error" class="alert alert-danger d-none"></div>
                        <form id="google-register-form">
                            <div class="mb-3">
                                <label for="google-username" class="form-label">Username</label>
                                <input type="text" class="form-control" id="google-username" required minlength="3">
                                <div class="form-text">Choose a unique username (3-100 characters)</div>
                            </div>
                            <div class="mb-3">
                                <label for="google-password" class="form-label">Password</label>
                                <input type="password" class="form-control" id="google-password" required minlength="6">
                                <div class="form-text">Choose a secure password (minimum 6 characters)</div>
                            </div>
                            <input type="hidden" id="google-id-token" value="${idToken || ''}">
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" id="complete-google-register">Complete Registration</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remove existing modal if any
    const existingModal = document.getElementById('googleRegisterModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Add modal to body
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('googleRegisterModal'));
    modal.show();
    
    // Handle registration submission
    document.getElementById('complete-google-register').addEventListener('click', async () => {
        const modalError = document.getElementById('modal-error');
        const submitBtn = document.getElementById('complete-google-register');
        
        try {
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Registering...';
            modalError.classList.add('d-none');
            
            const response = await fetch('/api/auth/google-oauth', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    id_token: document.getElementById('google-id-token').value,
                    username: document.getElementById('google-username').value,
                    password: document.getElementById('google-password').value
                })
            });
            
            const data = await response.json();
            
            if (!response.ok) {
                throw new Error(data.detail || 'Registration failed');
            }
            
            // Registration successful
            localStorage.setItem('access_token', data.access_token);
            modal.hide();
            window.location.href = '/servers-ui';
            
        } catch (error) {
            modalError.textContent = error.message;
            modalError.classList.remove('d-none');
            submitBtn.disabled = false;
            submitBtn.innerHTML = 'Complete Registration';
        }
    });
}

// Load Google Sign-In library on page load
loadGoogleSignIn();
</script>
{% endblock %}
